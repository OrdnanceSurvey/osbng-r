<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="osbng">
<title>Indexing Polygon Example • osbng</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Hanken_Grotesk-0.4.8/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Indexing Polygon Example">
<meta property="og:description" content="osbng">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">osbng</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/osbng_overview.html">osbng Overview</a>
    <a class="dropdown-item" href="../articles/osbng_indexing_polygon_examples.html">Indexing Polygon Example</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/OrdnanceSurvey/osbng-r/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Indexing Polygon Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/OrdnanceSurvey/osbng-r/blob/HEAD/vignettes/osbng_indexing_polygon_examples.Rmd" class="external-link"><code>vignettes/osbng_indexing_polygon_examples.Rmd</code></a></small>
      <div class="d-none name"><code>osbng_indexing_polygon_examples.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="british-national-grid-indexing-polygon-examples">British National Grid Indexing Polygon Examples<a class="anchor" aria-label="anchor" href="#british-national-grid-indexing-polygon-examples"></a>
</h2>
<p>A key component of the <code>osbng</code> package is the indexing
functionality. The <code>geom_to_bng</code> and
<code>geom_to_bng_intersection</code> functions enable the indexing of
geometries, represented using <a href="https://paleolimbot.github.io/geos/index.html" class="external-link"><code>geos</code></a>
geometry objects, into grid squares at a specified resolution. Both
functions accept <code>geos</code> (or optionally <a href="https://r-spatial.github.io/sf/index.html" class="external-link"><code>sf</code></a>)
objects of the following types: <code>Point</code>,
<code>LineString</code>, <code>Polygon</code>, <code>MultiPoint</code>,
<code>MultiLineString</code>, <code>MultiPolygon</code>, and
<code>GeometryCollection.</code> The geometry coordinates must be
encoded in the <a href="https://epsg.io/27700" class="external-link">British National Grid
(OSGB36) EPSG:27700</a> coordinate reference system.</p>
<p>These functions facilitate grid-based spatial analysis, enabling
applications such as statistical aggregation, data visualisation, and
data interoperability. The two functions differ in their operation:
<code>geom_to_bng</code> returns the British National Grid (BNG) grid
squares intersected by the input geometry, while
<code>geom_to_bng_intersection</code> returns the intersections (shared
areas) between the input geometry and the grid square geometries.</p>
<p>When deciding between the two functions, consider whether a
decomposition of the input geometry by BNG grid squares is required. The
decomposition logic is computationally more expensive but is useful when
the intersection between the input geometry and a grid square is needed.
This approach supports spatial join optimisations, such as
point-in-polygon and polygon-to-polygon operations, using the
<code>is_core</code> value of the indexed geometry object. These
optimisations are particularly valuable for geospatial analysis of
medium to large datasets in distributed processing systems, where
geometries may be colocated by their BNG references.</p>
<div class="section level3">
<h3 id="indexing-functions-accepting-geometries">Indexing Functions Accepting Geometries<a class="anchor" aria-label="anchor" href="#indexing-functions-accepting-geometries"></a>
</h3>
<div class="section level4">
<h4 id="geom_to_bng">geom_to_bng<a class="anchor" aria-label="anchor" href="#geom_to_bng"></a>
</h4>
<p>This function returns a list of <code>BNGReference</code> objects
representing the BNG grid squares intersected by the input geometry.
Note that <code>BNGReference</code> objects are deduplicated in cases
where multiple parts of a multi-part geometry intersect the same grid
square.</p>
</div>
<div class="section level4">
<h4 id="geom_to_bng_intersection">geom_to_bng_intersection<a class="anchor" aria-label="anchor" href="#geom_to_bng_intersection"></a>
</h4>
<p>This function returns a list of objects representing the
decomposition of the input geometry into BNG grid squares. Unlike
<code>geom_to_bng</code>, no deduplication occurs. If multiple parts of
a multi-part geometry intersect the same grid square, the intersection
for each part is returned.</p>
</div>
<div class="section level4">
<h4 id="geom_to_bng_intersection_explode">geom_to_bng_intersection_explode<a class="anchor" aria-label="anchor" href="#geom_to_bng_intersection_explode"></a>
</h4>
<p>This convenience function applies
<code><a href="../reference/geom_to_bng.html">geom_to_bng_intersection()</a></code> to each geometry in an
<code>sf</code> data.frame, returning a flattened data.frame by
exploding the list of indexed geometries.</p>
</div>
</div>
<div class="section level3">
<h3 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h3>
<p>The examples below demonstrate the application of the two indexing
functions using the London boundary from the administrative England
Regions dataset provided by the Office for National Statistics (ONS).
Metadata for this dataset is available from <code>?osbng::</code>. The
indexing functions are applied to geometries within an <code>sf</code>
spatial data frame.</p>
</div>
<div class="section level3">
<h3 id="optional-sf-dependency">Optional sf Dependency<a class="anchor" aria-label="anchor" href="#optional-sf-dependency"></a>
</h3>
<p>While <code>osbng</code> is fully compatible with sf and can
seamlessly work with data frames in <code>R</code>, it does not require
sf as a hard dependency. With the exception of
<code>geom_to_bng_intersection_explode</code>, the indexing functions
can operate directly on <code>geos</code> Geometry objects. This allows
you to use these functions with standard data structures (e.g., vectors,
data frames) containing geos geometries.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ordnancesurvey.github.io/osbng-r/" class="external-link">osbng</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.9.1, GDAL 3.3.2, PROJ 7.2.1; sf_use_s2() is TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read the Office for National Statistics (ONS) England Regions GeoPackage</span></span>
<span><span class="co"># Create an sf data frame</span></span>
<span><span class="co"># See examples/data/metadata.json for more information about the data source</span></span>
<span><span class="va">gdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>              <span class="st">"London_Regions_December_2024_Boundaries_EN_BFC.gpkg"</span>, </span>
<span>              package <span class="op">=</span> <span class="st">"osbng"</span><span class="op">)</span>, </span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Filter the data frame columns</span></span>
<span><span class="va">gdf_london</span> <span class="op">&lt;-</span> <span class="va">gdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RGN24CD"</span>, <span class="st">"RGN24NM"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Return the data frame</span></span>
<span><span class="va">gdf_london</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 503571.5 ymin: 155854.3 xmax: 561957.5 ymax: 200933.6</span></span>
<span><span class="co">#&gt; Projected CRS: OSGB 1936 / British National Grid</span></span>
<span><span class="co">#&gt;     RGN24CD RGN24NM                       geometry</span></span>
<span><span class="co">#&gt; 1 E12000007  London MULTIPOLYGON (((531024.6 20...</span></span></code></pre></div>
<p>Check/confirm the coordinate reference system used.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># osbng indexing functions require geometry coordinates to be specified </span></span>
<span><span class="co"># in British National Grid (BNG) (OSGB36) cordinate reference system</span></span>
<span><span class="co"># EPSG:27700</span></span>
<span><span class="co"># https://epsg.io/27700</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate Reference System:</span></span>
<span><span class="co">#&gt;   User input: OSGB 1936 / British National Grid </span></span>
<span><span class="co">#&gt;   wkt:</span></span>
<span><span class="co">#&gt; PROJCRS["OSGB 1936 / British National Grid",</span></span>
<span><span class="co">#&gt;     BASEGEOGCRS["OSGB 1936",</span></span>
<span><span class="co">#&gt;         DATUM["OSGB 1936",</span></span>
<span><span class="co">#&gt;             ELLIPSOID["Airy 1830",6377563.396,299.3249646,</span></span>
<span><span class="co">#&gt;                 LENGTHUNIT["metre",1]]],</span></span>
<span><span class="co">#&gt;         PRIMEM["Greenwich",0,</span></span>
<span><span class="co">#&gt;             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span><span class="co">#&gt;         ID["EPSG",4277]],</span></span>
<span><span class="co">#&gt;     CONVERSION["British National Grid",</span></span>
<span><span class="co">#&gt;         METHOD["Transverse Mercator",</span></span>
<span><span class="co">#&gt;             ID["EPSG",9807]],</span></span>
<span><span class="co">#&gt;         PARAMETER["Latitude of natural origin",49,</span></span>
<span><span class="co">#&gt;             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span><span class="co">#&gt;             ID["EPSG",8801]],</span></span>
<span><span class="co">#&gt;         PARAMETER["Longitude of natural origin",-2,</span></span>
<span><span class="co">#&gt;             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span><span class="co">#&gt;             ID["EPSG",8802]],</span></span>
<span><span class="co">#&gt;         PARAMETER["Scale factor at natural origin",0.9996012717,</span></span>
<span><span class="co">#&gt;             SCALEUNIT["unity",1],</span></span>
<span><span class="co">#&gt;             ID["EPSG",8805]],</span></span>
<span><span class="co">#&gt;         PARAMETER["False easting",400000,</span></span>
<span><span class="co">#&gt;             LENGTHUNIT["metre",1],</span></span>
<span><span class="co">#&gt;             ID["EPSG",8806]],</span></span>
<span><span class="co">#&gt;         PARAMETER["False northing",-100000,</span></span>
<span><span class="co">#&gt;             LENGTHUNIT["metre",1],</span></span>
<span><span class="co">#&gt;             ID["EPSG",8807]]],</span></span>
<span><span class="co">#&gt;     CS[Cartesian,2],</span></span>
<span><span class="co">#&gt;         AXIS["(E)",east,</span></span>
<span><span class="co">#&gt;             ORDER[1],</span></span>
<span><span class="co">#&gt;             LENGTHUNIT["metre",1]],</span></span>
<span><span class="co">#&gt;         AXIS["(N)",north,</span></span>
<span><span class="co">#&gt;             ORDER[2],</span></span>
<span><span class="co">#&gt;             LENGTHUNIT["metre",1]],</span></span>
<span><span class="co">#&gt;     USAGE[</span></span>
<span><span class="co">#&gt;         SCOPE["Engineering survey, topographic mapping."],</span></span>
<span><span class="co">#&gt;         AREA["United Kingdom (UK) - offshore to boundary of UKCS within 49°45'N to 61°N and 9°W to 2°E; onshore Great Britain (England, Wales and Scotland). Isle of Man onshore."],</span></span>
<span><span class="co">#&gt;         BBOX[49.75,-9,61.01,2.01]],</span></span>
<span><span class="co">#&gt;     ID["EPSG",27700]]</span></span></code></pre></div>
<div class="section level4">
<h4 id="geom_to_bng-1">geom_to_bng<a class="anchor" aria-label="anchor" href="#geom_to_bng-1"></a>
</h4>
<p>Returns a list of <code>BNGReference</code> objects representing the
BNG grid squares intersected by the input geometry. The
<code>BNGReference</code> provides functions to access and manipulate
the reference. This includes the following:</p>
<ul>
<li>
<code>print(x, compact = TRUE)</code>: The BNG reference with
whitespace removed.</li>
<li>
<code><a href="../reference/bng_to_bbox.html">bng_to_grid_geom()</a></code>: Returns a grid square as a
<code>geos</code> or <code>sf</code> Polygon.</li>
</ul>
<p>For more information on the BNG Reference object, see
<code><a href="../reference/as_bng_reference.html">?as_bng_reference</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Return the BNG grid squares intersected by the London Region</span></span>
<span><span class="co"># Uses `geom_to_bng()`</span></span>
<span><span class="co"># Uses a 5km grid square resolution</span></span>
<span><span class="co"># Returns a list of `BNGRefernce` objects for each geometry</span></span>
<span><span class="va">gdf_london</span><span class="op">$</span><span class="va">bng_ref_5km</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geom_to_bng.html">geom_to_bng</a></span><span class="op">(</span><span class="va">gdf_london</span>, resolution <span class="op">=</span> <span class="st">"5km"</span><span class="op">)</span></span></code></pre></div>
<p>The resulting data frame includes a list column containing all the
BNG reference objects that intersect the London region. To make it
easier to map these grid squares, we need to transform the data frame so
that each reference is its own row. The easiest way to do this is using
<code><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">tidyr::unnest</a></code>, but this example uses an alternative when
that package is not available.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Expand the bng_ref_5km column to separate rows for each BNG Reference object</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">$</span><span class="va">bng_ref_5km</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 bng_ref_5km <span class="op">=</span> <span class="fu"><a href="../reference/as_bng_reference.html">as_bng_reference</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">$</span><span class="va">bng_ref_5km</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a data frame of London and combine with BNG observations</span></span>
<span><span class="va">df_london</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Drop the original bng_ref_5km column</span></span>
<span><span class="va">df_london</span> <span class="op">&lt;-</span> <span class="va">df_london</span><span class="op">[</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df_london</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bng_ref_5km"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">df_london</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">df_london</span><span class="op">[</span><span class="va">df</span><span class="op">$</span><span class="va">id</span>, <span class="op">]</span>, <span class="va">df</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Alternative approach requiring `tidyr` - NOT RUN</span></span>
<span></span>
<span><span class="va">df_london</span> <span class="op">&lt;-</span> <span class="va">gdf_london</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span><span class="va">bng_ref_5km</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This new data frame contains a row for each of the BNG grid squares
that intersected the original region geometry. This column still
contains <code>BNGReference</code> objects, so we can extract
information about the reference, such as the geometry.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using the data frame with the set of BNG grid squares</span></span>
<span><span class="co"># Get the geometry for each grid square</span></span>
<span><span class="va">df_london</span><span class="op">$</span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bng_to_bbox.html">bng_to_grid_geom</a></span><span class="op">(</span><span class="va">df_london</span><span class="op">$</span><span class="va">bng_reference</span>, format <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert this data frame to an `sf` object with the grid square geometry</span></span>
<span><span class="va">gdf_london_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="va">df_london</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Return the first few rows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gdf_london_exp</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 4 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 515000 ymin: 155000 xmax: 550000 ymax: 160000</span></span>
<span><span class="co">#&gt; Projected CRS: OSGB 1936 / British National Grid</span></span>
<span><span class="co">#&gt;       RGN24CD RGN24NM id bng_reference                       geometry</span></span>
<span><span class="co">#&gt; 1   E12000007  London  1   &lt;TQ 1 5 NE&gt; POLYGON ((515000 155000, 52...</span></span>
<span><span class="co">#&gt; 1.1 E12000007  London  1   &lt;TQ 2 5 NE&gt; POLYGON ((525000 155000, 53...</span></span>
<span><span class="co">#&gt; 1.2 E12000007  London  1   &lt;TQ 3 5 NW&gt; POLYGON ((530000 155000, 53...</span></span>
<span><span class="co">#&gt; 1.3 E12000007  London  1   &lt;TQ 3 5 NE&gt; POLYGON ((535000 155000, 54...</span></span>
<span><span class="co">#&gt; 1.4 E12000007  London  1   &lt;TQ 4 5 NW&gt; POLYGON ((540000 155000, 54...</span></span>
<span><span class="co">#&gt; 1.5 E12000007  London  1   &lt;TQ 4 5 NE&gt; POLYGON ((545000 155000, 55...</span></span></code></pre></div>
<p>Now that we have the grid square geometries organised in a spatial
data frame, we can visualise the data and demonstrate the concept of
assigning geometries to BNG grid squares. Since this is an
<code>sf</code> object, <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">ggplot2::geom_sf</a></code> or
<code>tmap</code> can be used. Here we demonstrate an alternative
without dependencies.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the original London Region</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="st">"#ffc61e"</span>, </span>
<span>     border <span class="op">=</span> <span class="st">"#fff"</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"BNG Grid Squares at 5km Resolution Intersected by London Region"</span>,</span>
<span>     cex.main <span class="op">=</span> <span class="fl">.8</span>, </span>
<span>     extent <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">gdf_london_exp</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the indexed and exploded London regions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">gdf_london_exp</span><span class="op">)</span>, </span>
<span>     col <span class="op">=</span> <span class="cn">NA</span>, </span>
<span>     border <span class="op">=</span> <span class="st">"#333333"</span>, </span>
<span>     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add feature labels at grid square centroids</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">gdf_london_exp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="va">coords</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>     <span class="va">coords</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>,</span>
<span>     <span class="va">gdf_london_exp</span><span class="op">$</span><span class="va">bng_reference</span>, cex <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p><img src="osbng_indexing_polygon_examples_files/figure-html/map_bng-1.png" width="624"></p>
</div>
<div class="section level4">
<h4 id="geom_to_bng_intersection_explode-1">geom_to_bng_intersection_explode<a class="anchor" aria-label="anchor" href="#geom_to_bng_intersection_explode-1"></a>
</h4>
<p>Decomposes each geometry in the input <code>sf</code> data.frame
bounded by their presence in BNG grid squares at the specified
resolution. Applies the <code>geom_to_bng_intersection</code> function
to the active geometry column of the input data frame, which is expected
to be set and in the OSGB36 / British National Grid coordinate reference
system (CRS) (EPSG:27700).</p>
<p>The resulting indexed geometries are exploded into individual rows,
with each row containing a new column for each part of the nested list:
<code>bng_ref</code>, <code>is_core</code>, and
<code>geometry</code>.</p>
<p>The input geometry column is replaced with the <code>geometry</code>
column. The input geometry column can be retrieved if required by
joining the resulting data frame with the original data frame on the
index (if not reset), or using a feature identifier. Dropping the
original geometry column reduces memory usage and simplifies the
resulting object.</p>
<p>All non-geometry columns from the input are retained in the resulting
<code>sf</code> data frame.</p>
<p>The columns added to the exploded data frame:</p>
<ul>
<li>
<code>bng_ref</code>: The <code>BNGReference</code> object
representing the grid square corresponding to the decomposition.</li>
<li>
<code>is_core</code>: A Boolean flag indicating whether the grid
square geometry is entirely contained by the input geometry. This is
relevant for Polygon geometries and helps distinguish between “core”
(fully inside)and “edge” (partially overlapping) grid squares.</li>
<li>
<code>geometry</code>: The geometry representing the intersection
between the input geometry and the grid square. This can be one of a
number of geometry types depending on the overlap. When
<code>is_core</code> is True, geom is the same as the grid square
geometry.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a new data frame of the London Region</span></span>
<span><span class="co"># Filter the data frame columns</span></span>
<span><span class="va">gdf_london</span> <span class="op">&lt;-</span> <span class="va">gdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RGN24CD"</span>, <span class="st">"RGN24NM"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Decompose the London Region into a simplified representation</span></span>
<span><span class="co"># bounded by its presence in each BNG grid square at a 5km resolution</span></span>
<span><span class="co"># Uses the gdf_to_bng_geom_intersection_explode; sf required</span></span>
<span><span class="va">gdf_london_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geom_to_bng_intersection_explode.html">geom_to_bng_intersection_explode</a></span><span class="op">(</span><span class="va">gdf_london</span>, </span>
<span>                                                   resolution <span class="op">=</span> <span class="st">"5km"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gdf_london_exp</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 4 fields</span></span>
<span><span class="co">#&gt; Geometry type: GEOMETRY</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 516482.1 ymin: 155854.3 xmax: 546026.9 ymax: 160000</span></span>
<span><span class="co">#&gt; Projected CRS: OSGB 1936 / British National Grid</span></span>
<span><span class="co">#&gt;     RGN24CD RGN24NM bng_reference is_core                       geometry</span></span>
<span><span class="co">#&gt; 1 E12000007  London   &lt;TQ 1 5 NE&gt;   FALSE POLYGON ((516934.9 160000, ...</span></span>
<span><span class="co">#&gt; 2 E12000007  London   &lt;TQ 2 5 NE&gt;   FALSE POLYGON ((529998.6 157302.2...</span></span>
<span><span class="co">#&gt; 3 E12000007  London   &lt;TQ 3 5 NW&gt;   FALSE POLYGON ((534994.8 159511.3...</span></span>
<span><span class="co">#&gt; 4 E12000007  London   &lt;TQ 3 5 NE&gt;   FALSE MULTIPOLYGON (((535881.7 16...</span></span>
<span><span class="co">#&gt; 5 E12000007  London   &lt;TQ 4 5 NW&gt;   FALSE POLYGON ((544965.3 156784.3...</span></span>
<span><span class="co">#&gt; 6 E12000007  London   &lt;TQ 4 5 NE&gt;   FALSE POLYGON ((546019.3 159994.4...</span></span></code></pre></div>
<p>This spatial data frame contains decomposed London Region’s geometry
decomposed into BNG grid squares. Using this expanded set of records
demonstrates the <code>is_core</code> property when grid squares are
fully contained by the original geometry.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot the indexed and expanded London Region spatial data frame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gdf_london_exp</span><span class="op">[</span><span class="st">"is_core"</span><span class="op">]</span>,</span>
<span>     border <span class="op">=</span> <span class="st">"#fff"</span>,</span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#009ade"</span>, <span class="st">"#ff1f5b"</span><span class="op">)</span><span class="op">[</span><span class="va">gdf_london_exp</span><span class="op">$</span><span class="va">is_core</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"Decomposition of the London Region into BNG Grid Squares at 5km Resolution"</span>,</span>
<span>     cex.main <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.3</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"is_core"</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True"</span>, <span class="st">"False"</span><span class="op">)</span>,</span>
<span>       fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#ff1f5b"</span>, <span class="st">"#009ade"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="osbng_indexing_polygon_examples_files/figure-html/viz_is_core-1.png" width="624"></p>
</div>
<div class="section level4">
<h4 id="alternative-geom_to_bng_intersection">Alternative: geom_to_bng_intersection<a class="anchor" aria-label="anchor" href="#alternative-geom_to_bng_intersection"></a>
</h4>
<p>The example below demonstrates how the same data frame
<code>gdf_london_exp</code> could be derived using more verbose logic
via the <code>geom_to_bng_intersection</code> function.</p>
<p>Starting again with the original London Region, the intersecting BNG
grid squares are identified and then the decomposed geometry is exploded
into separate rows.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a new data frame of the London Region</span></span>
<span><span class="co"># Filter the data frame columns</span></span>
<span><span class="va">gdf_london</span> <span class="op">&lt;-</span> <span class="va">gdf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RGN24CD"</span>, <span class="st">"RGN24NM"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Decompose the London Region intoa simplified representation bounded by its</span></span>
<span><span class="co"># presence in each BNG grid square at a 5km resolution.</span></span>
<span><span class="co"># Uses the geom_to_bng_intersection function</span></span>
<span><span class="co"># Returns a list of nested lists</span></span>
<span><span class="va">gdf_london</span><span class="op">$</span><span class="va">bng_ref_5km</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geom_to_bng.html">geom_to_bng_intersection</a></span><span class="op">(</span><span class="va">gdf_london</span>, </span>
<span>                                                   resolution <span class="op">=</span> <span class="st">"5km"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Drop original geometry column</span></span>
<span><span class="va">gdf_london</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">)</span></span></code></pre></div>
<p>Given the list column of BNG reference objects, there are several
ways to expand and flatten this into multiple rows. One option is using
<code><a href="https://tidyr.tidyverse.org/reference/unnest_wider.html" class="external-link">tidyr::unnest_wider</a></code> followed by <code><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">tidyr::unnest</a></code>.
The example code below shows an alternative approach without the
dependency on <code>tidyr</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Alternative syntax - NOT RUN</span></span>
<span><span class="co"># Expand the bng_ref_5km column to separate rows for each object.</span></span>
<span><span class="va">gdf_london</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"RGN24CD"</span> <span class="op">=</span> <span class="va">gdf_london</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RGN24CD"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">$</span><span class="va">bng_ref_5km</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert this data frame to an `sf` object with the grid square geometry</span></span>
<span><span class="va">gdf_london_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="va">gdf_london</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Return the first few rows of the GeoDataFrame</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gdf_london_exp</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Alternative approach requiring `tidyr` - NOT RUN</span></span>
<span><span class="va">gdf_london_exp</span> <span class="op">&lt;-</span> <span class="va">gdf_london</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">bng_ref_5km</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">BNGReference</span>, <span class="va">is_core</span>, <span class="va">geom</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Chris Jochem, Ordnance Survey Ltd.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
